Bootstrap: docker
From: debian:13

%environment
export OMPI_MCA_btl_vader_single_copy_mechanism=none

%labels
AUTHOR christophe.trophime@lncmi.cnrs.fr

%post
apt update
apt install -y debian-keyring curl wget gpg bash-completion tree coreutils

# Configure apt and install packages \
wget -qO - http://apt.feelpp.org/apt.gpg | apt-key add -
echo "deb http://apt.feelpp.org/ubuntu/noble noble latest" | tee -a /etc/apt/sources.list.d/feelpp.list
rm -f apt.gpg
apt update

cp /usr/share/keyrings/debian-maintainers.gpg /etc/apt/trusted.gpg.d 
apt-get update 
apt-get -y install git iproute2 procps lsb-release iputils-ping nmap 

apt-get -y install python3-minimal libpython3-dev
apt-get -y install python-is-python3 python3-pip python3-venv python3-jinja2
apt-get -y install python3-matplotlib 
apt-get -y install python3-statsmodels 
apt-get -y install python3-pandas python3-seaborn 
apt-get -y install python3-numpy python3-scipy 
apt-get -y install python3-nlopt python3-tabulate 
apt-get -y install python3-pip python-is-python3 
apt-get -y install python3-pint 
apt-get -y install python3-decouple python3-requests python3-natsort 
apt-get -y install python3-iapws 
apt-get -y install jsonlint yamllint
apt-get -y install zutty 
apt-get -y install texlive-latex-base texlive-latex-extra dvipng cm-super-minimal

apt-get -y install feelpp-quickstart feelpp-data \
    feelpp-toolboxes \
    feelpp-toolboxes-coefficientformpdes \
    feelpp-toolboxes-data\
    feelpp-toolboxes-electric \
    feelpp-toolboxes-hdg \
    feelpp-toolboxes-heat \
    feelpp-toolboxes-heatfluid \
    feelpp-toolboxes-solid \
    feelpp-toolboxes-thermoelectric \
    feelpp-tools \
    python3-feelpp \
    python3-feelpp-toolboxes \
    python3-feelpp-toolboxes-coefficientformpdes \
    python3-feelpp-toolboxes-core \
    python3-feelpp-toolboxes-electric \
    python3-feelpp-toolboxes-hdg  \
    python3-feelpp-toolboxes-heat \
    python3-feelpp-toolboxes-solid \
    python3-feelpp-toolboxes-thermoelectric

# install magnetworkflows
echo "deb http://euler.lncmig.local/~christophe.trophime@LNCMIG.local/debian/ $(lsb_release -cs) main" > /etc/apt/sources.list.d/lncmi.list
apt-get update
apt-get -y install python3-simple-pid
apt-get -y install python3-magnettools python3-magnetworkflows

# create custom motd
# Install figlet!
apt update
apt install -y figlet python-is-python3

version=$(/usr/bin/feelpp_mesh_partitioner --version 2>/dev/null | tail -1 | cut -d ":" -f2)

cat > /.singularity.d/env/99-motd.sh <<EOF   
case \$0 in
    /.singularity.d/actions/shell)
        figlet ${version}
        echo
        echo "MagnetWorflows (Feelpp Toolboxes)"
        echo
        echo "Hello \$USER from shell" ;;
    /.singularity.d/actions/exec)
        echo "Hello \$USER from exec" ;;
    /.singularity.d/actions/run)
        echo "Hello \$USER from run" ;;
    /.singularity.d/actions/test)
        echo "Hello \$USER from test" ;;
esac
EOF